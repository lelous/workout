<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Workout Journal Pro</title>
    <meta name="description" content="Advanced workout tracking with progressive overload, analytics, and smart suggestions">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --bg-primary: #f2f2f7; --bg-secondary: #ffffff; --bg-accent: #f8f9fa;
            --text-primary: #1c1c1e; --text-secondary: #8e8e93; --text-tertiary: #c7c7cc;
            --border-color: #e5e5ea;
            --primary-grad: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-grad: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --primary: #667eea; --danger: #ff3b30; --success: #34c759; --warning: #ff9500;
            --shadow: 0 4px 12px rgba(0,0,0,0.06);
            --font-main: 'Exo 2', -apple-system, sans-serif;
        }
        [data-theme="dark"] {
            --bg-primary: #000000; --bg-secondary: #1c1c1e; --bg-accent: #2c2c2e;
            --text-primary: #ffffff; --text-secondary: #aeaeb2; --text-tertiary: #636366;
            --border-color: #38383a; --shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-main);
            background: var(--bg-primary); color: var(--text-primary);
            padding-bottom: calc(130px + env(safe-area-inset-bottom));
            transition: background 0.3s ease;
        }
        
        textarea, input, select {
            font-family: var(--font-main);
            font-size: 16px !important; padding: 12px; border-radius: 12px;
            border: 1px solid var(--border-color); background: var(--bg-secondary);
            color: var(--text-primary); width: 100%; -webkit-appearance: none;
        }
        
        .header {
            background: var(--primary-grad); color: white;
            padding: calc(45px + env(safe-area-inset-top)) 20px 20px;
            text-align: center; position: sticky; top: 0; z-index: 100;
            border-bottom-left-radius: 24px; border-bottom-right-radius: 24px;
            box-shadow: var(--shadow);
        }
        .header-actions { position: absolute; right: 20px; bottom: 20px; display: flex; gap: 12px; }
        .header-left { position: absolute; left: 20px; bottom: 20px; display: flex; gap: 12px; }
        
        .icon-btn {
            background: rgba(255,255,255,0.15); border: none; color: white; padding: 8px;
            border-radius: 50%; width: 36px; height: 36px; cursor: pointer; backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .icon-btn:active { transform: scale(0.95); }
        
        .back-btn {
            background: rgba(255,255,255,0.15); border: none; color: white; padding: 8px 12px 8px 8px;
            border-radius: 12px; font-weight: 600; font-family: var(--font-main);
            display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 14px;
            transition: all 0.2s;
        }
        .back-btn:active { transform: scale(0.95); }
        
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .card { 
            background: var(--bg-secondary); border-radius: 20px; padding: 20px; 
            margin-bottom: 16px; box-shadow: var(--shadow); position: relative;
        }
        .card h3 { color: var(--primary); margin-bottom: 10px; font-size: 18px; display: flex; align-items: center; justify-content: space-between; font-weight: 700; }
        
        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 14px;
            font-size: 16px; font-weight: 700; color: white; margin-bottom: 10px;
            font-family: var(--font-main);
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.2s, opacity 0.2s;
        }
        .btn:active { transform: scale(0.98); opacity: 0.8; }
        .btn-primary { background: var(--primary-grad); }
        .btn-success { background: var(--success-grad); }
        .btn-secondary { background: var(--bg-accent); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-danger-full { background: var(--danger); color: white; }
        .btn-danger { background: rgba(255, 59, 48, 0.1); color: var(--danger); width: auto; padding: 8px 12px; font-size: 13px; }
        
        .action-btn-minimal {
            background: transparent; border: none; color: var(--text-secondary);
            padding: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: color 0.2s, transform 0.2s;
        }
        .action-btn-minimal:active { color: var(--primary); transform: scale(0.95); }
        
        /* Progressive Overload Suggestion Badge */
        .suggestion-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--success);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            animation: pulse 2s infinite;
            z-index: 10;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(52, 199, 89, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(52, 199, 89, 0); }
        }
        .suggestion-badge:active {
            transform: scale(0.95);
            animation: none;
        }
        
        /* Trend Indicators */
        .trend-indicator {
            font-size: 18px;
            margin-left: 8px;
            display: inline-flex;
            align-items: center;
        }
        .trend-up { color: var(--success); }
        .trend-down { color: var(--danger); }
        .trend-same { color: var(--text-tertiary); }
        
        .set-row { 
            display: flex; gap: 8px; align-items: center; margin-bottom: 12px;
            transition: all 0.3s; position: relative;
        }
        .set-row.completed {
            opacity: 0.5;
        }
        .set-row.completed::after {
            content: '✓';
            position: absolute;
            right: -35px;
            color: var(--success);
            font-weight: bold;
            font-size: 24px;
            animation: checkmark 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes checkmark {
            0% { transform: scale(0) rotate(-45deg); opacity: 0; }
            50% { transform: scale(1.3) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        
        .set-label { 
            width: 30px; font-weight: 800; font-size: 18px; 
            color: var(--text-tertiary); text-align: center; 
            font-feature-settings: "tnum";
            cursor: pointer;
            transition: color 0.2s;
        }
        .set-label:active { color: var(--success); }
        
        .set-input { 
            width: 75px; text-align: center; font-weight: 700; 
            flex-shrink: 0; transition: border-color 0.2s; 
        }
        .set-input:focus { border-color: var(--primary); outline: none; }
        
        .autofill-btn {
            background: transparent; color: var(--primary); border: none;
            width: 30px; height: 30px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; opacity: 0.7;
            transition: opacity 0.2s, transform 0.2s;
        }
        .autofill-btn:active { opacity: 1; transform: scale(1.2); }
        
        .add-set-btn {
            width: 100%; border: 1px dashed var(--border-color); background: transparent;
            color: var(--text-secondary); padding: 10px; border-radius: 12px;
            font-weight: 600; cursor: pointer; font-size: 14px;
            transition: background 0.2s;
        }
        .add-set-btn:active { background: var(--bg-accent); }

        .timer-display {
            position: fixed; bottom: calc(110px + env(safe-area-inset-bottom)); right: 20px;
            background: var(--primary-grad); color: white; width: 70px; height: 70px;
            border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: 800; font-size: 18px; box-shadow: 0 8px 20px rgba(0,0,0,0.3); z-index: 99;
        }
        .timer-controls { display: flex; gap: 15px; margin-top: 2px; }
        .timer-mod { font-size: 10px; cursor: pointer; opacity: 0.8; }
        .timer-mod:active { opacity: 1; }

        .session-timer-container {
            background: rgba(0,0,0,0.05); padding: 6px 12px; border-radius: 12px;
            display: flex; align-items: center; gap: 8px;
        }
        .session-timer {
            font-size: 14px; font-weight: 700; font-feature-settings: "tnum"; 
            color: var(--primary); cursor: pointer;
        }
        
        .nav { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); 
            display: flex; justify-content: space-around; 
            padding: 12px 0 calc(12px + env(safe-area-inset-bottom)); 
            border-top: 1px solid var(--border-color); z-index: 1000; 
        }
        [data-theme="dark"] .nav { background: rgba(28,28,30,0.9); }
        
        .nav-btn { 
            background: transparent; border: none; padding: 4px; cursor: pointer; 
            display: flex; flex-direction: column; align-items: center; gap: 4px; 
            flex: 1; color: var(--text-secondary); transition: color 0.2s;
        }
        .nav-btn.active { color: var(--primary); }
        .nav-label { font-size: 10px; font-weight: 600; font-family: var(--font-main); }
        
        /* Active Workout Banner */
        .active-workout-banner {
            position: fixed;
            bottom: calc(76px + env(safe-area-inset-bottom));
            left: 0;
            right: 0;
            background: var(--primary-grad);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 999;
            cursor: pointer;
            box-shadow: 0 -2px 12px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
            animation: subtlePulse 3s ease-in-out infinite;
        }
        @keyframes subtlePulse {
            0%, 100% { box-shadow: 0 -2px 12px rgba(0,0,0,0.15); }
            50% { box-shadow: 0 -2px 20px rgba(102,126,234,0.4); }
        }
        .active-workout-banner:active {
            transform: scale(0.98);
        }
        .workout-banner-text {
            flex: 1;
        }
        .workout-banner-title {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 2px;
            text-transform: capitalize;
        }
        .workout-banner-time {
            font-size: 12px;
            opacity: 0.9;
        }
        .workout-banner-icon {
            font-size: 20px;
        }
        
        svg { stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        
        .day-card { 
            background: var(--bg-secondary); padding: 16px; border-radius: 16px; 
            margin-bottom: 12px; border-left: 5px solid var(--primary); 
            box-shadow: var(--shadow); cursor: pointer; 
            display: flex; justify-content: space-between; align-items: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .day-card:active { transform: scale(0.98); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .stat-card { background: var(--bg-secondary); padding: 15px; border-radius: 16px; text-align: center; box-shadow: var(--shadow); }
        .stat-val { font-size: 24px; font-weight: 800; color: var(--primary); }
        .stat-lbl { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
        
        .history-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); 
        }
        .history-exercise { 
            border-bottom: 1px solid var(--border-color); 
            padding: 8px 0; font-size: 14px; 
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: calc(60px + env(safe-area-inset-top));
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            pointer-events: none;
        }
        .toast {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 14px 20px;
            border-radius: 14px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 10px;
            min-width: 250px;
            max-width: 90vw;
            animation: slideDown 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            pointer-events: all;
        }
        @keyframes slideDown {
            from { transform: translateY(-100px) scale(0.8); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        .toast.hiding {
            animation: slideUp 0.3s ease-out forwards;
        }
        @keyframes slideUp {
            to { transform: translateY(-100px) scale(0.8); opacity: 0; }
        }
        .toast-success { border-left: 4px solid var(--success); }
        .toast-error { border-left: 4px solid var(--danger); }
        .toast-info { border-left: 4px solid var(--primary); }
        .toast-warning { border-left: 4px solid var(--warning); }
        
        /* Note Modal */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9998;
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .note-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            padding: 24px;
            padding-bottom: calc(24px + env(safe-area-inset-bottom));
            box-shadow: 0 -4px 32px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: slideUpModal 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes slideUpModal {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        /* Deload Banner */
        .deload-banner {
            background: linear-gradient(135deg, rgba(255,149,0,0.15) 0%, rgba(255,204,0,0.15) 100%);
            border: 2px solid var(--warning);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .deload-icon { font-size: 32px; }
        .deload-text h4 { color: var(--warning); margin-bottom: 4px; font-size: 16px; }
        .deload-text p { font-size: 13px; color: var(--text-secondary); }
        
        /* Muscle Group Bars */
        .muscle-group-bar {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        .muscle-group-label {
            width: 90px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: capitalize;
        }
        .muscle-group-progress {
            flex: 1;
            height: 28px;
            background: var(--bg-accent);
            border-radius: 14px;
            overflow: hidden;
            position: relative;
        }
        .muscle-group-fill {
            height: 100%;
            background: var(--primary-grad);
            transition: width 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
        }
        .muscle-group-value {
            font-size: 11px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        /* Best Day Cards */
        .best-day-card {
            background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .best-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .best-day-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            text-transform: capitalize;
        }
        .best-day-stat {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
        }
        
        /* Swipeable Cards */
        .swipeable {
            position: relative;
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .swipeable.swiping {
            transition: none;
        }
        .swipe-actions {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }
        .swipe-delete-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 13px;
        }
        
        .barbell-container { 
            display: flex; align-items: center; justify-content: center; 
            margin-top: 15px; overflow-x: auto; padding: 10px 0; 
        }
        .bar-end { width: 15px; height: 10px; background: #999; border-radius: 2px; }
        .bar-shaft { width: 40px; height: 10px; background: #999; }
        .plate { height: 60px; width: 10px; margin: 0 1px; border-radius: 2px; border: 1px solid rgba(0,0,0,0.1); }
        .plate-45 { background: #0047AB; height: 70px; } 
        .plate-35 { background: #FFD700; height: 60px; } 
        .plate-25 { background: #008000; height: 50px; } 
        .plate-10 { background: #E0E0E0; height: 40px; } 
        .plate-5 { background: #333; height: 35px; } 
        .plate-2_5 { background: #333; height: 30px; }

        .chart-svg { width: 100%; height: 180px; font-size: 10px; overflow: visible; }
        .chart-grid { stroke: var(--border-color); stroke-width: 1; stroke-dasharray: 4; }
        .chart-line { fill: none; stroke: var(--primary); stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; }
        .chart-label { fill: var(--text-secondary); text-anchor: end; dominant-baseline: middle; font-size: 10px; }
        .chart-axis { fill: var(--text-secondary); text-anchor: middle; font-size: 10px; }
        
        .segmented-control {
            display: flex; background: var(--bg-primary); padding: 4px; border-radius: 12px; margin-bottom: 16px;
        }
        .segment-btn {
            flex: 1; border: none; background: transparent; padding: 8px; font-size: 13px; font-weight: 600;
            color: var(--text-secondary); border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .segment-btn.active { background: var(--bg-secondary); color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        .last-workout {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-left: 50px;
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icons = {
            Home: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>,
            Dumbbell: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M6.5 6.5h11"></path><path d="M6.5 17.5h11"></path><path d="M6 20v-2a6 6 0 1 1 12 0v2"></path><path d="M6 4v2a6 6 0 1 0 12 0V4"></path></svg>,
            Chart: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>,
            History: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
            Back: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M19 12H5"></path><path d="M12 19l-7-7 7-7"></path></svg>,
            Moon: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>,
            Sun: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line></svg>,
            Export: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>,
            Trash: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            Edit: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
            ChevronRight: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="9 18 15 12 9 6"></polyline></svg>,
            Magic: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="M4.93 4.93l1.41 1.41"></path><path d="M17.66 17.66l1.41 1.41"></path><path d="M4.93 19.07l1.41-1.41"></path><path d="M17.66 6.34l1.41-1.41"></path></svg>,
            User: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>,
            Up: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="18 15 12 9 6 15"></polyline></svg>,
            Down: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="6 9 12 15 18 9"></polyline></svg>,
            Warmup: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3.9 1.7 2.2 2.9 2.9 3.3z"></path></svg>,
            Upload: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>,
            Plus: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Close: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
            Note: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>,
            Download: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
        };

        const DEFAULT_WORKOUTS = {
            monday: { name: "Upper Push", focus: "Chest, Shoulders, Triceps", muscleGroups: ["chest", "shoulders", "triceps"], exercises: [ { name: "Flat Barbell Bench Press", sets: 4, reps: "6-8", rest: 240, description: "Lie on flat bench, feet flat on floor. Lower bar to mid-chest, press up." }, { name: "Incline Dumbbell Press", sets: 3, reps: "8-10", rest: 180, description: "Set bench to 30-45°. Press dumbbells up from chest level." }, { name: "Standing Overhead Press", sets: 4, reps: "6-8", rest: 180, description: "Stand with barbell at shoulders. Press overhead, lock out arms." }, { name: "Cable Flyes", sets: 3, reps: "12-15", rest: 90, description: "Set cables at chest height. Bring handles together in front of chest." }, { name: "Lateral Raises", sets: 3, reps: "12-15", rest: 60, description: "Raise dumbbells out to sides until parallel to floor." }, { name: "Dips", sets: 3, reps: "8-12", rest: 120, description: "Lean forward slightly for chest emphasis. Lower until upper arms parallel." }, { name: "Tricep Pushdowns", sets: 3, reps: "12-15", rest: 60, description: "Keep elbows pinned to sides. Push down until arms fully extended." } ] },
            tuesday: { name: "Lower", focus: "Quads, Hamstrings, Glutes", muscleGroups: ["quads", "hamstrings", "glutes"], exercises: [ { name: "Squats", sets: 4, reps: "6-8", rest: 240, description: "Feet shoulder-width. Sit back and down. Knees track over toes." }, { name: "Romanian Deadlifts", sets: 4, reps: "8-10", rest: 180, description: "Slight knee bend. Hinge at hips. Push hips back." }, { name: "Bulgarian Split Squats", sets: 3, reps: "10-12/leg", rest: 120, description: "Rear foot elevated. Lower front knee to 90°." }, { name: "Leg Press", sets: 3, reps: "12-15", rest: 120, description: "Lower until knees at 90°. Push through heels." }, { name: "Leg Curls", sets: 3, reps: "12-15", rest: 90, description: "Curl heels toward glutes. Squeeze hamstrings." }, { name: "Walking Lunges", sets: 3, reps: "12/leg", rest: 90, description: "Step forward, lower back knee." }, { name: "Calf Raises", sets: 4, reps: "15-20", rest: 60, description: "Rise up on balls of feet. Hold squeeze at top." } ] },
            wednesday: { name: "Cardio & Core", focus: "Conditioning, Abs", muscleGroups: ["core"], exercises: [ { name: "Treadmill Incline Walk", sets: 1, reps: "30 min", rest: 0, description: "3.5-4.0 mph at 12-15% incline. Zone 2 cardio." }, { name: "Plank", sets: 3, reps: "60s", rest: 60, description: "Forearms on ground. Keep body straight. Squeeze glutes and abs." }, { name: "Dead Bug", sets: 3, reps: "12/side", rest: 60, description: "Lie on back. Opposite arm and leg extend. Keep lower back flat." }, { name: "Russian Twists", sets: 3, reps: "20 total", rest: 60, description: "Hold weight at chest. Rotate side to side. Feet elevated." }, { name: "Bicycle Crunches", sets: 3, reps: "20 total", rest: 60, description: "Opposite elbow to knee. Slow and controlled." }, { name: "Hollow Body Hold", sets: 3, reps: "30s", rest: 60, description: "Lower back pressed to floor. Arms overhead. Legs extended." }, { name: "Mountain Climbers", sets: 3, reps: "30s", rest: 60, description: "Plank position. Drive knees to chest alternating. Fast pace." } ] },
            thursday: { name: "Upper Pull", focus: "Back, Rear Delts", muscleGroups: ["back", "biceps"], exercises: [ { name: "Pull-Ups", sets: 4, reps: "6-10", rest: 180, description: "Pull chest to bar. Full extension at bottom." }, { name: "T-Bar Rows", sets: 4, reps: "8-10", rest: 180, description: "Hinge at hips. Pull to lower chest. Squeeze shoulder blades." }, { name: "Barbell/DB Rows", sets: 4, reps: "8-12", rest: 180, description: "Pull to hip/lower chest. Retract shoulder blades." }, { name: "Cable Rows", sets: 3, reps: "10-12", rest: 120, description: "Sit upright. Pull handle to lower chest." }, { name: "Face Pulls", sets: 3, reps: "15-20", rest: 90, description: "Pull to face level. External rotation at end." }, { name: "Chest-Supported Rows", sets: 3, reps: "12-15", rest: 90, description: "Set bench to 30-45°. Lie chest-down. Pull handles to lower chest." } ] },
            friday: { name: "Lower", focus: "Quads, Hamstrings, Glutes", muscleGroups: ["quads", "hamstrings", "glutes"], exercises: [ { name: "Front/Goblet Squat", sets: 4, reps: "8-10", rest: 180, description: "Torso upright. Elbows up." }, { name: "Leg Press", sets: 4, reps: "10-12", rest: 120, description: "Feet shoulder-width, mid-platform. Lower to 90°." }, { name: "Hack Squat", sets: 3, reps: "12-15", rest: 90, description: "Lower controlled. Drive through heels. Quad focus." }, { name: "Stiff-Leg Deadlifts", sets: 3, reps: "10-12", rest: 120, description: "Slight knee bend. Hinge at hips. Feel stretch in hamstrings." }, { name: "Leg Curls", sets: 3, reps: "12-15", rest: 90, description: "Lying or seated. Curl heels to glutes. Slow negative." }, { name: "Reverse Lunges", sets: 3, reps: "10/leg", rest: 90, description: "Hold goblet dumbbell. Step back. Lower back knee down." } ] }
        };

        // Toast notification system
        const ToastContext = React.createContext();
        
        function ToastProvider({ children }) {
            const [toasts, setToasts] = useState([]);
            
            const showToast = (message, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => {
                    setToasts(prev => prev.filter(t => t.id !== id));
                }, 3000);
            };
            
            return (
                <ToastContext.Provider value={{ showToast }}>
                    {children}
                    <div className="toast-container">
                        {toasts.map(toast => (
                            <div key={toast.id} className={`toast toast-${toast.type}`}>
                                {toast.type === 'success' && '✓'}
                                {toast.type === 'error' && '✕'}
                                {toast.type === 'warning' && '⚠️'}
                                {toast.type === 'info' && 'ℹ️'}
                                <span>{toast.message}</span>
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        }
        
        // Haptic feedback helper
        const haptic = (type = 'light') => {
            if (!navigator.vibrate) return;
            const patterns = {
                light: 10,
                medium: 20,
                heavy: [50, 30, 50],
                success: [100, 50, 100, 50, 100]
            };
            navigator.vibrate(patterns[type] || patterns.light);
        };

        function App() {
            const [view, setView] = useState('home');
            const [selectedDay, setSelectedDay] = useState(null);
            const [workoutLog, setWorkoutLog] = useState({});
            const [customWorkouts, setCustomWorkouts] = useState(DEFAULT_WORKOUTS);
            const [measurements, setMeasurements] = useState([]);
            const [personalRecords, setPersonalRecords] = useState({});
            const [darkMode, setDarkMode] = useState(false);
            const [loading, setLoading] = useState(true);
            const [nutrition, setNutrition] = useState({ protein: 180, carbs: 250, fats: 70, calories: 2800 });

            useEffect(() => {
                const load = (k) => { try { return JSON.parse(localStorage.getItem(k)); } catch(e) { return null; }};
                const savedCustom = load('customWorkouts');
                setWorkoutLog(load('workouts') || {});
                setCustomWorkouts((savedCustom && Object.keys(savedCustom).length > 0) ? savedCustom : DEFAULT_WORKOUTS);
                setMeasurements(load('measurements') || []);
                setPersonalRecords(load('personal-records') || {});
                setNutrition(load('nutrition') || { protein: 180, carbs: 250, fats: 70, calories: 2800 });
                if (localStorage.getItem('dark-mode') === 'true') { setDarkMode(true); document.documentElement.setAttribute('data-theme', 'dark'); }
                setLoading(false);
            }, []);

            useEffect(() => {
                if (!loading) {
                    localStorage.setItem('workouts', JSON.stringify(workoutLog));
                    localStorage.setItem('customWorkouts', JSON.stringify(customWorkouts));
                    localStorage.setItem('measurements', JSON.stringify(measurements));
                    localStorage.setItem('personal-records', JSON.stringify(personalRecords));
                    localStorage.setItem('nutrition', JSON.stringify(nutrition));
                    localStorage.setItem('dark-mode', darkMode);
                }
            }, [workoutLog, customWorkouts, measurements, personalRecords, darkMode, nutrition, loading]);

            const toggleDarkMode = () => { 
                setDarkMode(!darkMode); 
                document.documentElement.setAttribute('data-theme', !darkMode ? 'dark' : 'light'); 
                haptic('light');
            };
            
            const deleteWorkout = (date) => { 
                const n = { ...workoutLog }; 
                delete n[date]; 
                setWorkoutLog(n); 
            };

            if (loading) return <div className="container"><h2>Loading...</h2></div>;

            return (
                <ToastProvider>
                    <div>
                        <Header view={view} setView={setView} setSelectedDay={setSelectedDay} darkMode={darkMode} toggleDarkMode={toggleDarkMode} />
                        <div className="container">
                            {view === 'home' && <Home setView={setView} workoutLog={workoutLog} customWorkouts={customWorkouts} nutrition={nutrition} setNutrition={setNutrition} />}
                            {view === 'workout' && <Workout selectedDay={selectedDay} setSelectedDay={setSelectedDay} customWorkouts={customWorkouts} setCustomWorkouts={setCustomWorkouts} workoutLog={workoutLog} setWorkoutLog={setWorkoutLog} personalRecords={personalRecords} setPersonalRecords={setPersonalRecords} />}
                            {view === 'stats' && <Stats workoutLog={workoutLog} personalRecords={personalRecords} customWorkouts={customWorkouts} />}
                            {view === 'manage' && <Manage customWorkouts={customWorkouts} setCustomWorkouts={setCustomWorkouts} measurements={measurements} setMeasurements={setMeasurements} workoutLog={workoutLog} nutrition={nutrition} setNutrition={setNutrition} />}
                            {view === 'history' && <History workoutLog={workoutLog} setWorkoutLog={setWorkoutLog} customWorkouts={customWorkouts} deleteWorkout={deleteWorkout} />}
                        </div>
                        <ActiveWorkoutBanner view={view} setView={setView} setSelectedDay={setSelectedDay} customWorkouts={customWorkouts} />
                        <Nav view={view} setView={setView} />
                    </div>
                </ToastProvider>
            );
        }

        function Header({ view, setView, setSelectedDay, darkMode, toggleDarkMode }) {
            return (
                <div className="header">
                    {view === 'home' ? (
                        <div className="header-left"><button className="icon-btn" onClick={() => setView('manage')}><Icons.User /></button></div>
                    ) : (
                        <button className="back-btn" onClick={() => {setView('home'); setSelectedDay(null); haptic('light');}}><Icons.Back /> Back</button>
                    )}
                    <h1>{view === 'home' ? 'Workout Pro' : view.toUpperCase()}</h1>
                    <div className="header-actions">
                        <button className="icon-btn" onClick={toggleDarkMode}>{darkMode ? <Icons.Sun /> : <Icons.Moon />}</button>
                    </div>
                </div>
            );
        }

        function Nav({ view, setView }) {
            const tabs = [ {id:'home',icon:<Icons.Home/>,label:'Home'}, {id:'workout',icon:<Icons.Dumbbell/>,label:'Train'}, {id:'stats',icon:<Icons.Chart/>,label:'Stats'}, {id:'history',icon:<Icons.History/>,label:'History'} ];
            return (
                <div className="nav">
                    {tabs.map(t => <button key={t.id} className={`nav-btn ${view === t.id ? 'active' : ''}`} onClick={() => { setView(t.id); haptic('light'); }}>{t.icon}<span className="nav-label">{t.label}</span></button>)}
                </div>
            );
        }

        function ActiveWorkoutBanner({ view, setView, setSelectedDay, customWorkouts }) {
            const [sessionData, setSessionData] = useState(null);
            const [elapsed, setElapsed] = useState(0);

            useEffect(() => {
                const checkSession = () => {
                    const saved = localStorage.getItem('active-workout-session');
                    if (saved) {
                        try {
                            const data = JSON.parse(saved);
                            // Only show if session is less than 8 hours old
                            if (Date.now() - data.timestamp < 8 * 60 * 60 * 1000) {
                                setSessionData(data);
                                // Calculate elapsed time
                                const timeDiff = Math.floor((Date.now() - data.timestamp) / 1000) + (data.elapsed || 0);
                                setElapsed(timeDiff);
                            } else {
                                localStorage.removeItem('active-workout-session');
                            }
                        } catch (e) {
                            console.error('Failed to parse session:', e);
                        }
                    } else {
                        setSessionData(null);
                    }
                };

                checkSession();
                const interval = setInterval(checkSession, 1000);
                return () => clearInterval(interval);
            }, [view]);

            const formatTime = (seconds) => {
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = seconds % 60;
                if (h > 0) return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                return `${m}:${s.toString().padStart(2, '0')}`;
            };

            const returnToWorkout = () => {
                setSelectedDay(sessionData.day);
                setView('workout');
                haptic('medium');
            };

            // Don't show banner if no session or already on workout view
            if (!sessionData || view === 'workout') return null;

            const workoutName = customWorkouts[sessionData.day]?.name || sessionData.day;

            return (
                <div className="active-workout-banner" onClick={returnToWorkout}>
                    <div className="workout-banner-text">
                        <div className="workout-banner-title">{workoutName}</div>
                        <div className="workout-banner-time">{formatTime(elapsed)} • Tap to resume</div>
                    </div>
                    <div className="workout-banner-icon">▶</div>
                </div>
            );
        }

        function Home({ setView, workoutLog, customWorkouts, nutrition, setNutrition }) {
            const { showToast } = React.useContext(ToastContext);
            
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + 1);
            const endOfWeek = new Date(today);
            endOfWeek.setDate(today.getDate() - today.getDay() + 7);
            
            const weeklyCount = Object.keys(workoutLog).filter(date => {
                const d = new Date(date);
                return d >= startOfWeek && d <= endOfWeek;
            }).length;

            // Deload detection - check last 4 weeks
            const last4Weeks = [];
            for (let i = 0; i < 4; i++) {
                const weekStart = new Date(startOfWeek);
                weekStart.setDate(weekStart.getDate() - (i * 7));
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 7);
                
                const weekVolume = Object.entries(workoutLog)
                    .filter(([date]) => {
                        const d = new Date(date);
                        return d >= weekStart && d < weekEnd;
                    })
                    .reduce((sum, [, data]) => sum + (data.tonnage || 0), 0);
                
                last4Weeks.push(weekVolume);
            }
            
            const needsDeload = last4Weeks.length >= 2 && 
                                last4Weeks[0] < last4Weeks[1] * 0.7 && 
                                last4Weeks[1] < last4Weeks[2] * 0.7;

            return (
                <div>
                    {needsDeload && (
                        <div className="deload-banner">
                            <div className="deload-icon">⚠️</div>
                            <div className="deload-text">
                                <h4>Deload Week Suggested</h4>
                                <p>Volume has dropped 2 weeks in a row. Consider taking it easier this week for recovery.</p>
                            </div>
                        </div>
                    )}
                    
                    <div className="card" style={{background: 'var(--primary-grad)', color: 'white'}}>
                        <h2 style={{margin:0, color:'white', opacity:0.9}}>Weekly Goal</h2>
                        <h1 style={{fontSize:'48px', margin:'5px 0'}}>{weeklyCount}/5</h1>
                        <p style={{opacity:0.8, fontSize:'14px'}}>Workouts this week</p>
                    </div>

                    <div className="card">
                        <h3>Daily Nutrition Targets</h3>
                        <div className="stat-grid" style={{marginBottom:'0'}}>
                            <div className="stat-card">
                                <div className="stat-val">{nutrition.protein || 180}g</div>
                                <div className="stat-lbl">Protein</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-val">{nutrition.carbs || 250}g</div>
                                <div className="stat-lbl">Carbs</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-val">{nutrition.fats || 70}g</div>
                                <div className="stat-lbl">Fats</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-val">{nutrition.calories || 2800}</div>
                                <div className="stat-lbl">Calories</div>
                            </div>
                        </div>
                    </div>
                    
                    <button className="btn btn-primary" onClick={() => { setView('workout'); haptic('medium'); }}>Start New Session</button>
                    <button className="btn btn-secondary" onClick={() => setView('stats')}>Stats & Analytics</button>
                    
                    <div className="card"><h3>Schedule</h3>
                        {Object.entries(customWorkouts).map(([k,v]) => <div key={k} style={{padding:'8px 0', borderBottom:'1px solid var(--border-color)', textTransform:'capitalize'}}><strong>{k}</strong>: {v.name}</div>)}
                    </div>
                </div>
            );
        }

        function Manage({ customWorkouts, setCustomWorkouts, measurements, setMeasurements, workoutLog, nutrition, setNutrition }) {
            const { showToast } = React.useContext(ToastContext);
            const [viewDay, setViewDay] = useState(null);
            const [newDay, setNewDay] = useState('');
            const [weightForm, setWeightForm] = useState('');
            const fileInput = useRef(null);

            const deleteDay = (key) => { 
                const n = {...customWorkouts}; 
                delete n[key]; 
                setCustomWorkouts(n); 
                showToast('Day deleted', 'success'); 
                haptic('medium');
            };
            
            const addDay = () => { 
                if(newDay) { 
                    setCustomWorkouts({...customWorkouts, [newDay.toLowerCase()]: { name: newDay, exercises: [], muscleGroups: [] }}); 
                    setNewDay(''); 
                    showToast('Day added', 'success'); 
                    haptic('medium');
                } 
            };
            
            const moveExercise = (day, idx, dir) => {
                const n = {...customWorkouts}; 
                const exs = n[day].exercises;
                if (dir === -1 && idx > 0) { [exs[idx], exs[idx-1]] = [exs[idx-1], exs[idx]]; }
                if (dir === 1 && idx < exs.length - 1) { [exs[idx], exs[idx+1]] = [exs[idx+1], exs[idx]]; }
                setCustomWorkouts(n);
                haptic('light');
            };
            
            const moveDay = (fromIdx, toIdx) => {
                const days = Object.keys(customWorkouts);
                const [movedDay] = days.splice(fromIdx, 1);
                days.splice(toIdx, 0, movedDay);
                
                const reordered = {};
                days.forEach(day => {
                    reordered[day] = customWorkouts[day];
                });
                setCustomWorkouts(reordered);
                haptic('light');
                showToast('Day order updated', 'success');
            };
            
            const deleteEx = (day, idx) => { 
                const n = {...customWorkouts}; 
                n[day].exercises.splice(idx, 1); 
                setCustomWorkouts(n); 
                showToast('Exercise removed', 'success'); 
                haptic('medium');
            };
            
            const addEx = (day) => { 
                const name = prompt("Exercise Name:"); 
                if(name) { 
                    const n = {...customWorkouts}; 
                    n[day].exercises.push({name, sets:3, reps:"10-12"}); 
                    setCustomWorkouts(n); 
                    showToast('Exercise added', 'success'); 
                    haptic('medium');
                } 
            };
            
            const handleImport = (e) => {
                const file = e.target.files[0]; 
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => { 
                    try { 
                        const data = JSON.parse(e.target.result); 
                        Object.keys(data).forEach(k => localStorage.setItem(k, JSON.stringify(data[k]))); 
                        showToast('Data imported successfully!', 'success'); 
                        haptic('success');
                        setTimeout(() => window.location.reload(), 1000); 
                    } catch(err) { 
                        showToast('Invalid file format', 'error'); 
                        haptic('medium');
                    } 
                };
                reader.readAsText(file);
            };

            const exportToCSV = () => {
                let csv = 'Date,Day,Exercise,Set,Weight,Reps,Volume,Notes\n';
                Object.entries(workoutLog).sort().forEach(([date, data]) => {
                    data.exercises?.forEach(ex => {
                        ex.logs.forEach((log, idx) => {
                            if (log.weight && log.reps) {
                                const vol = parseFloat(log.weight) * parseFloat(log.reps);
                                // Include exercise note only on first set
                                const note = idx === 0 ? (ex.note || '') : '';
                                csv += `${date},${data.day},${ex.name},${idx + 1},${log.weight},${log.reps},${vol},"${note.replace(/"/g, '""')}"\n`;
                            }
                        });
                    });
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `workout-export-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                showToast('CSV exported!', 'success');
                haptic('success');
            };

            const resetHistory = () => { 
                setMeasurements([]); 
                showToast('Weight history cleared', 'success'); 
                haptic('medium');
            };

            const dataPoints = measurements.slice(-10);
            const maxW = Math.max(...dataPoints.map(d => parseFloat(d.weight)), 0) + 5;
            const minW = Math.min(...dataPoints.map(d => parseFloat(d.weight)), 200) - 5;
            
            const points = dataPoints.map((m, i, arr) => {
                const y = 100 - ((m.weight - minW) / (maxW - minW) * 100); 
                return `${i * (300 / (arr.length > 1 ? arr.length - 1 : 1))},${y}`;
            }).join(' ');

            if (viewDay) return (
                <div>
                    <div style={{display:'flex', gap:'10px', marginBottom:'20px', alignItems:'center'}}>
                        <button className="icon-btn" style={{background:'var(--primary)'}} onClick={() => setViewDay(null)}><Icons.Back/></button>
                        <h2 style={{textTransform:'capitalize'}}>{viewDay}</h2>
                    </div>
                    <div style={{marginBottom:'20px'}}>
                        <input value={customWorkouts[viewDay].name} onChange={e => { const n = {...customWorkouts}; n[viewDay].name = e.target.value; setCustomWorkouts(n); }} placeholder="Routine Name" />
                    </div>
                    {customWorkouts[viewDay].exercises.map((ex, i) => (
                        <div key={i} className="card" style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                            <span style={{fontWeight:'600'}}>{ex.name}</span>
                            <div style={{display:'flex', gap:'8px'}}>
                                <button className="autofill-btn" onClick={() => moveExercise(viewDay, i, -1)}><Icons.Up/></button>
                                <button className="autofill-btn" onClick={() => moveExercise(viewDay, i, 1)}><Icons.Down/></button>
                                <button className="action-btn-minimal" style={{color:'var(--danger)'}} onClick={() => deleteEx(viewDay, i)}><Icons.Trash/></button>
                            </div>
                        </div>
                    ))}
                    <button className="btn btn-primary" onClick={() => addEx(viewDay)}>+ Add Exercise</button>
                </div>
            );

            return (
                <div>
                    <div className="card">
                        <h3>Nutrition Targets</h3>
                        <div className="stat-grid" style={{marginBottom:'15px'}}>
                            <div className="stat-card">
                                <div className="stat-val">{nutrition.protein}g</div>
                                <div className="stat-lbl">Protein</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-val">{nutrition.carbs}g</div>
                                <div className="stat-lbl">Carbs</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-val">{nutrition.fats}g</div>
                                <div className="stat-lbl">Fats</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-val">{nutrition.calories}</div>
                                <div className="stat-lbl">Calories</div>
                            </div>
                        </div>
                        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'8px'}}>
                            <input 
                                type="number" 
                                inputMode="decimal" 
                                placeholder="Protein (g)" 
                                value={nutrition.protein}
                                onChange={e => setNutrition({...nutrition, protein: parseInt(e.target.value) || 0})} 
                                style={{fontSize:'14px', padding:'10px'}} 
                            />
                            <input 
                                type="number" 
                                inputMode="decimal" 
                                placeholder="Carbs (g)" 
                                value={nutrition.carbs}
                                onChange={e => setNutrition({...nutrition, carbs: parseInt(e.target.value) || 0})} 
                                style={{fontSize:'14px', padding:'10px'}} 
                            />
                            <input 
                                type="number" 
                                inputMode="decimal" 
                                placeholder="Fats (g)" 
                                value={nutrition.fats}
                                onChange={e => setNutrition({...nutrition, fats: parseInt(e.target.value) || 0})} 
                                style={{fontSize:'14px', padding:'10px'}} 
                            />
                            <input 
                                type="number" 
                                inputMode="decimal" 
                                placeholder="Calories" 
                                value={nutrition.calories}
                                onChange={e => setNutrition({...nutrition, calories: parseInt(e.target.value) || 0})} 
                                style={{fontSize:'14px', padding:'10px'}} 
                            />
                        </div>
                    </div>
                    
                    <div className="card">
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                            <h3>Weight Trend</h3>
                            <button className="action-btn-minimal" style={{color:'var(--danger)', fontSize:'12px'}} onClick={resetHistory}><Icons.Trash/></button>
                        </div>
                        <div style={{display:'flex', alignItems:'center'}}>
                            <div style={{width:'30px', height:'150px', display:'flex', flexDirection:'column', justifyContent:'space-between', fontSize:'10px', color:'var(--text-secondary)', textAlign:'right', paddingRight:'5px'}}>
                                {measurements.length > 0 && <span>{Math.round(maxW)}</span>}
                                {measurements.length > 0 && <span>{Math.round(minW)}</span>}
                            </div>
                            <div className="chart-wrapper" style={{width:'100%', height:'150px'}}>
                                <svg className="chart-svg" viewBox="0 0 300 100" preserveAspectRatio="none">
                                    <line x1="0" y1="25" x2="300" y2="25" className="chart-grid" />
                                    <line x1="0" y1="50" x2="300" y2="50" className="chart-grid" />
                                    <line x1="0" y1="75" x2="300" y2="75" className="chart-grid" />
                                    {measurements.length > 1 && <polyline points={points} className="chart-line" />}
                                </svg>
                            </div>
                        </div>
                        <div style={{display:'flex', gap:'10px', marginTop:'10px'}}>
                            <input type="number" inputMode="decimal" placeholder="Lbs" value={weightForm} onChange={e => setWeightForm(e.target.value)} />
                            <button className="btn btn-primary" style={{width:'auto', margin:0}} onClick={() => { 
                                if(weightForm) { 
                                    setMeasurements([...measurements, {date:new Date().toISOString(), weight:weightForm}]); 
                                    setWeightForm(''); 
                                    showToast('Weight logged!', 'success'); 
                                    haptic('medium');
                                }
                            }}>Log</button>
                        </div>
                    </div>

                    <div className="card">
                        <h3>Schedule Editor</h3>
                        {Object.keys(customWorkouts).map((d, idx) => {
                            const days = Object.keys(customWorkouts);
                            return (
                                <div key={d} style={{display:'flex', justifyContent:'space-between', padding:'10px 0', borderBottom:'1px solid var(--border-color)', alignItems:'center'}}>
                                    <span style={{fontWeight:'bold', textTransform:'capitalize', cursor:'pointer', flex: 1}} onClick={() => setViewDay(d)}>{d}</span>
                                    <div style={{display:'flex', gap:'8px', alignItems:'center'}}>
                                        <button 
                                            className="autofill-btn" 
                                            onClick={() => moveDay(idx, idx - 1)}
                                            style={{opacity: idx === 0 ? 0.3 : 1}}
                                            disabled={idx === 0}
                                            title="Move up"
                                        >
                                            <Icons.Up/>
                                        </button>
                                        <button 
                                            className="autofill-btn" 
                                            onClick={() => moveDay(idx, idx + 1)}
                                            style={{opacity: idx === days.length - 1 ? 0.3 : 1}}
                                            disabled={idx === days.length - 1}
                                            title="Move down"
                                        >
                                            <Icons.Down/>
                                        </button>
                                        <button className="action-btn-minimal" onClick={() => setViewDay(d)} title="Edit"><Icons.Edit/></button>
                                        <button className="action-btn-minimal" style={{color:'var(--danger)'}} onClick={() => deleteDay(d)} title="Delete"><Icons.Trash/></button>
                                    </div>
                                </div>
                            );
                        })}
                        <div style={{marginTop:'20px', display:'flex', gap:'10px'}}>
                            <input placeholder="New Day Name" value={newDay} onChange={e => setNewDay(e.target.value)} />
                            <button className="btn btn-success" style={{width:'auto'}} onClick={addDay}>Add</button>
                        </div>
                    </div>
                    
                    <div className="card">
                        <h3>Data Management</h3>
                        <div style={{display:'flex', gap:'10px', flexWrap:'wrap'}}>
                            <button className="btn btn-secondary" onClick={() => fileInput.current.click()}>
                                <Icons.Upload/> Import JSON
                            </button>
                            <button className="btn btn-secondary" onClick={exportToCSV}>
                                <Icons.Download/> Export CSV
                            </button>
                            <input type="file" ref={fileInput} style={{display:'none'}} accept=".json" onChange={handleImport} />
                        </div>
                        <button className="btn btn-danger" onClick={() => { 
                            if(confirm('Reset all workouts to defaults? This cannot be undone.')) {
                                localStorage.removeItem('customWorkouts'); 
                                showToast('Resetting to defaults...', 'info'); 
                                setTimeout(() => window.location.reload(), 1000); 
                            }
                        }}>Reset to Defaults</button>
                    </div>
                </div>
            );
        }

        function Workout({ selectedDay, setSelectedDay, customWorkouts, setCustomWorkouts, workoutLog, setWorkoutLog, personalRecords, setPersonalRecords }) {
            const { showToast } = React.useContext(ToastContext);
            const [sets, setSets] = useState([]);
            const [rest, setRest] = useState(0);
            const [plateCalc, setPlateCalc] = useState('');
            const [expandedEx, setExpandedEx] = useState({});
            const [sessionStart] = useState(Date.now());
            const [elapsed, setElapsed] = useState(0);
            const [paused, setPaused] = useState(false);
            const [completedSets, setCompletedSets] = useState({});
            const [draggedDay, setDraggedDay] = useState(null);
            const [addExerciseModal, setAddExerciseModal] = useState(false);
            const [newExerciseName, setNewExerciseName] = useState('');
            const [reorderMode, setReorderMode] = useState(false);
            const [workoutStarted, setWorkoutStarted] = useState(false);
            const [workoutNotes, setWorkoutNotes] = useState({});

            // Get history for an exercise/set
            const getHistory = (exName, setIndex) => {
                const dates = Object.keys(workoutLog).sort().reverse();
                for (let d of dates) {
                    const ex = workoutLog[d].exercises?.find(e => e.name === exName);
                    if (ex && ex.logs[setIndex] && ex.logs[setIndex].weight) return ex.logs[setIndex];
                }
                return null;
            };

            // Get trend direction
            const getTrend = (exName) => {
                const dates = Object.keys(workoutLog).sort().reverse().slice(0, 3);
                const weights = dates.map(d => {
                    const ex = workoutLog[d].exercises?.find(e => e.name === exName);
                    const maxWeight = ex?.logs ? Math.max(...ex.logs.map(l => parseFloat(l.weight) || 0)) : 0;
                    return maxWeight > 0 ? maxWeight : null;
                }).filter(w => w !== null);
                
                if (weights.length < 2) return null;
                if (weights[0] > weights[1]) return 'up';
                if (weights[0] < weights[1]) return 'down';
                return 'same';
            };

            // Calculate progressive overload suggestion
            const getSuggestion = (exName) => {
                const hist = getHistory(exName, 0);
                if (!hist) return null;
                
                const lastWeight = parseFloat(hist.weight);
                const lastReps = parseInt(hist.reps);
                
                // Progressive overload logic
                if (lastReps >= 10) {
                    return { weight: lastWeight + 5, reason: `+5lbs (hit ${lastReps} reps last time)` };
                } else if (lastReps >= 8) {
                    return { weight: lastWeight + 2.5, reason: '+2.5lbs' };
                } else {
                    return { weight: lastWeight, reason: 'same weight, aim for more reps' };
                }
            };

            const autoFill = (exIndex, setIndex) => {
                const newSets = [...sets];
                const hist = getHistory(sets[exIndex].name, setIndex);
                if (hist && !newSets[exIndex].logs[setIndex].weight) {
                    newSets[exIndex].logs[setIndex].weight = hist.weight;
                    newSets[exIndex].logs[setIndex].reps = hist.reps;
                } else if (setIndex > 0) {
                    newSets[exIndex].logs[setIndex].weight = newSets[exIndex].logs[setIndex-1].weight;
                    newSets[exIndex].logs[setIndex].reps = newSets[exIndex].logs[setIndex-1].reps;
                }
                setSets(newSets);
                showToast('Auto-filled!', 'info');
                haptic('light');
            };

            const applySuggestion = (exIndex) => {
                const suggestion = getSuggestion(sets[exIndex].name);
                if (suggestion) {
                    const newSets = [...sets];
                    newSets[exIndex].logs[0].weight = suggestion.weight.toString();
                    setSets(newSets);
                    showToast(`Applied: ${suggestion.weight}lbs`, 'success');
                    haptic('medium');
                }
            };

            const calcWarmup = (weight) => {
                const w = parseFloat(weight);
                if(!w) { showToast('Enter working weight first', 'warning'); return; }
                const warmups = [
                    `Bar (45lbs) × 10 reps`,
                    `${Math.round(w*0.5/5)*5}lbs × 5 reps`,
                    `${Math.round(w*0.7/5)*5}lbs × 3 reps`,
                    `${Math.round(w*0.9/5)*5}lbs × 1 rep`
                ];
                showToast(`Warmup for ${w}lbs: ${warmups.join(', ')}`, 'info');
            };

            const markSetComplete = (exIdx, setIdx) => {
                const key = `${exIdx}-${setIdx}`;
                setCompletedSets(prev => ({ ...prev, [key]: true }));
                haptic('medium');
                setTimeout(() => {
                    setCompletedSets(prev => {
                        const next = { ...prev };
                        delete next[key];
                        return next;
                    });
                }, 2000);
            };

            const addSet = (exIdx) => {
                const newSets = [...sets];
                newSets[exIdx].logs.push({ reps: '', weight: '', note: '' });
                setSets(newSets);
                haptic('light');
            };

            const removeSet = (exIdx, setIdx) => {
                const newSets = [...sets];
                newSets[exIdx].logs.splice(setIdx, 1);
                setSets(newSets);
                haptic('light');
            };

            const addExerciseToWorkout = () => {
                if (!newExerciseName.trim()) return;
                const newSets = [...sets];
                newSets.push({
                    name: newExerciseName.trim(),
                    logs: Array(3).fill().map(() => ({ reps: '', weight: '' }))
                });
                setSets(newSets);
                setNewExerciseName('');
                setAddExerciseModal(false);
                showToast('Exercise added', 'success');
                haptic('medium');
            };

            const removeExercise = (exIdx) => {
                if (confirm('Remove this exercise from workout?')) {
                    const newSets = [...sets];
                    newSets.splice(exIdx, 1);
                    setSets(newSets);
                    showToast('Exercise removed', 'success');
                    haptic('medium');
                }
            };

            const moveExercise = (exIdx, direction) => {
                const newSets = [...sets];
                const targetIdx = exIdx + direction;
                if (targetIdx < 0 || targetIdx >= newSets.length) return;
                
                [newSets[exIdx], newSets[targetIdx]] = [newSets[targetIdx], newSets[exIdx]];
                setSets(newSets);
                haptic('light');
            };

            const openNoteModal = (exIdx, setIdx) => {
                // Deprecated - notes are now per-exercise, not per-set
            };

            const saveNote = () => {
                // Deprecated - notes are now per-exercise, not per-set
            };

            // Auto-save workout session to prevent data loss
            useEffect(() => {
                if (selectedDay && sets.length > 0 && workoutStarted) {
                    const sessionData = {
                        day: selectedDay,
                        sets: sets,
                        elapsed: elapsed,
                        timestamp: Date.now(),
                        workoutNotes: workoutNotes
                    };
                    localStorage.setItem('active-workout-session', JSON.stringify(sessionData));
                }
            }, [sets, elapsed, selectedDay, workoutStarted, workoutNotes]);

            // Restore previous session or initialize new workout
            useEffect(() => {
                if (selectedDay && customWorkouts[selectedDay]) {
                    // Try to restore saved session
                    const saved = localStorage.getItem('active-workout-session');
                    if (saved) {
                        try {
                            const sessionData = JSON.parse(saved);
                            // Only restore if it's the same day and within last 8 hours
                            if (sessionData.day === selectedDay && (Date.now() - sessionData.timestamp) < 8 * 60 * 60 * 1000) {
                                setSets(sessionData.sets);
                                setWorkoutNotes(sessionData.workoutNotes || {});
                                setWorkoutStarted(true);
                                showToast('Restored previous session', 'info');
                                haptic('light');
                                return;
                            }
                        } catch (e) {
                            console.error('Failed to restore session:', e);
                        }
                    }
                    
                    // Initialize new workout only if not already started
                    if (!workoutStarted) {
                        setSets(customWorkouts[selectedDay].exercises.map(ex => ({
                            name: ex.name,
                            logs: Array(ex.sets || 3).fill().map(() => ({ reps: '', weight: '' }))
                        })));
                        setWorkoutNotes({});
                    }
                }
            }, [selectedDay, workoutStarted]);

            useEffect(() => {
                const timer = setInterval(() => { 
                    if(!paused) setElapsed(Math.floor((Date.now() - sessionStart) / 1000)); 
                }, 1000);
                return () => clearInterval(timer);
            }, [sessionStart, paused]);

            useEffect(() => {
                let timer;
                if (rest > 0) {
                    timer = setInterval(() => setRest(r => r - 1), 1000);
                } else if (rest === 0 && navigator.vibrate) {
                    haptic('heavy');
                    showToast('Rest complete!', 'success');
                }
                return () => clearInterval(timer);
            }, [rest]);

            const finish = () => {
                const date = new Date().toISOString().split('T')[0];
                let tonnage = 0;
                let newPrs = {...personalRecords};
                let hitPr = false;
                
                // Add notes to each exercise
                const setsWithNotes = sets.map((ex, idx) => ({
                    ...ex,
                    note: workoutNotes[idx] || ''
                }));
                
                setsWithNotes.forEach(ex => ex.logs.forEach(l => {
                    if(l.weight && l.reps) {
                        tonnage += parseFloat(l.weight) * parseFloat(l.reps);
                        const oneRM = parseFloat(l.weight) * (1 + parseFloat(l.reps)/30);
                        const key = ex.name.toLowerCase().replace(/[^a-z0-9]/g, '-');
                        if(!newPrs[key] || oneRM > newPrs[key]) { 
                            newPrs[key] = oneRM; 
                            hitPr = true; 
                        }
                    }
                }));
                
                setPersonalRecords(newPrs);
                setWorkoutLog({...workoutLog, [date]: { 
                    day: selectedDay, 
                    exercises: setsWithNotes, 
                    tonnage, 
                    duration: elapsed, 
                    completed: true 
                }});
                
                // Clear autosaved session and reset workout state
                localStorage.removeItem('active-workout-session');
                
                if (hitPr) {
                    confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 } });
                    haptic('success');
                    showToast(`🎉 NEW PR! Total Volume: ${tonnage.toLocaleString()} lbs`, 'success');
                } else {
                    showToast(`Workout Complete! Volume: ${tonnage.toLocaleString()} lbs`, 'success');
                    haptic('heavy');
                }
                
                setSelectedDay(null);
                setWorkoutStarted(false);
                setWorkoutNotes({});
            };

            const discardWorkout = () => {
                if (confirm('Discard this workout? All progress will be lost.')) {
                    localStorage.removeItem('active-workout-session');
                    setSelectedDay(null);
                    setWorkoutStarted(false);
                    setSets([]);
                    setWorkoutNotes({});
                    showToast('Workout discarded', 'info');
                    haptic('medium');
                }
            };

            const calculatePlates = (val) => {
                const w = parseFloat(val); 
                if(!w) return [];
                const side = (w - 45) / 2; 
                if(side <= 0) return [];
                const plates = [45, 25, 10, 5, 2.5]; 
                let rem = side; 
                const res = [];
                plates.forEach(p => { 
                    const c = Math.floor(rem/p); 
                    if(c>0){ 
                        res.push({weight: p, count: c}); 
                        rem -= p*c; 
                    }
                });
                return res;
            };

            const formatTime = (s) => {
                const m = Math.floor(s / 60);
                const sec = s % 60;
                return `${m}:${sec < 10 ? '0' : ''}${sec}`;
            };

            const editTime = () => {
                const newMins = prompt("Session Duration (minutes):", Math.floor(elapsed/60));
                if (newMins !== null && !isNaN(newMins)) {
                    setElapsed(parseInt(newMins) * 60);
                    haptic('light');
                }
            };

            if (!selectedDay) {
                const workoutDays = Object.keys(customWorkouts);
                
                const moveDay = (fromIdx, toIdx) => {
                    const days = Object.keys(customWorkouts);
                    const [movedDay] = days.splice(fromIdx, 1);
                    days.splice(toIdx, 0, movedDay);
                    
                    const reordered = {};
                    days.forEach(day => {
                        reordered[day] = customWorkouts[day];
                    });
                    setCustomWorkouts(reordered);
                    haptic('light');
                };
                
                return (
                    <div>
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:'20px'}}>
                            <h2 style={{margin:0}}>Select Workout</h2>
                            <button 
                                className="btn btn-secondary" 
                                style={{width:'auto', padding:'8px 16px', margin:0, fontSize:'14px'}}
                                onClick={() => { setReorderMode(!reorderMode); haptic('light'); }}
                            >
                                {reorderMode ? '✓ Done' : '☰ Reorder'}
                            </button>
                        </div>
                        {workoutDays.map((k, idx) => {
                            const v = customWorkouts[k];
                            return (
                                <div key={k} className="day-card" onClick={() => { if (!reorderMode) { setSelectedDay(k); haptic('medium'); } }}>
                                    <div style={{flex: 1}}>
                                        <div style={{fontWeight:'700', fontSize:'16px', textTransform:'capitalize', marginBottom:'4px'}}>{k}</div>
                                        <div style={{fontSize:'13px', color:'var(--text-secondary)'}}>{v.name}</div>
                                    </div>
                                    {reorderMode ? (
                                        <div style={{display:'flex', gap:'8px'}}>
                                            <button 
                                                className="icon-btn" 
                                                style={{background:'var(--primary)', opacity: idx === 0 ? 0.3 : 1}}
                                                onClick={(e) => { e.stopPropagation(); if (idx > 0) moveDay(idx, idx - 1); }}
                                                disabled={idx === 0}
                                            >
                                                <Icons.Up />
                                            </button>
                                            <button 
                                                className="icon-btn" 
                                                style={{background:'var(--primary)', opacity: idx === workoutDays.length - 1 ? 0.3 : 1}}
                                                onClick={(e) => { e.stopPropagation(); if (idx < workoutDays.length - 1) moveDay(idx, idx + 1); }}
                                                disabled={idx === workoutDays.length - 1}
                                            >
                                                <Icons.Down />
                                            </button>
                                        </div>
                                    ) : (
                                        <Icons.ChevronRight />
                                    )}
                                </div>
                            );
                        })}
                    </div>
                );
            }

            // Workout Overview Screen
            if (selectedDay && !workoutStarted) {
                const workout = customWorkouts[selectedDay];
                const totalSets = workout.exercises.reduce((sum, ex) => sum + (ex.sets || 3), 0);
                const estimatedTime = totalSets * 3; // Rough estimate: 3 min per set
                
                return (
                    <div>
                        <div className="card" style={{background: 'var(--primary-grad)', color: 'white', textAlign: 'center'}}>
                            <h1 style={{margin: 0, marginBottom: '8px', textTransform: 'capitalize', color: 'white'}}>{selectedDay}</h1>
                            <h2 style={{margin: 0, opacity: 0.9, fontWeight: 600, color: 'white'}}>{workout.name}</h2>
                            <div style={{display: 'flex', justifyContent: 'center', gap: '20px', marginTop: '15px', fontSize: '14px', opacity: 0.9}}>
                                <span>{workout.exercises.length} exercises</span>
                                <span>•</span>
                                <span>{totalSets} sets</span>
                                <span>•</span>
                                <span>~{estimatedTime} min</span>
                            </div>
                        </div>

                        <div className="card">
                            <h3 style={{marginBottom: '15px'}}>Exercises</h3>
                            {workout.exercises.map((ex, idx) => (
                                <div key={idx} style={{
                                    padding: '12px',
                                    borderBottom: idx < workout.exercises.length - 1 ? '1px solid var(--border-color)' : 'none',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center'
                                }}>
                                    <div style={{flex: 1}}>
                                        <div style={{fontWeight: '600', marginBottom: '4px'}}>{ex.name}</div>
                                        {ex.description && (
                                            <div style={{fontSize: '12px', color: 'var(--text-secondary)'}}>{ex.description}</div>
                                        )}
                                    </div>
                                    <div style={{
                                        background: 'var(--bg-accent)',
                                        padding: '4px 12px',
                                        borderRadius: '8px',
                                        fontSize: '13px',
                                        fontWeight: '600',
                                        color: 'var(--text-secondary)',
                                        whiteSpace: 'nowrap',
                                        marginLeft: '12px'
                                    }}>
                                        {ex.sets || 3} × {ex.reps}
                                    </div>
                                </div>
                            ))}
                        </div>

                        <button 
                            className="btn btn-success" 
                            style={{fontSize: '18px', padding: '20px'}}
                            onClick={() => { 
                                setWorkoutStarted(true); 
                                showToast('Workout started!', 'success');
                                haptic('heavy'); 
                            }}
                        >
                            Start Workout
                        </button>
                        <button 
                            className="btn btn-secondary" 
                            onClick={() => { 
                                setSelectedDay(null); 
                                setWorkoutStarted(false);
                                haptic('light'); 
                            }}
                        >
                            Cancel
                        </button>
                    </div>
                );
            }

            const plates = calculatePlates(plateCalc);

            return (
                <div>
                    <div className="card">
                        <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                            <div>
                                <h2 style={{margin:0, textTransform:'capitalize'}}>{selectedDay}</h2>
                                <div className="session-timer-container">
                                    <div className="session-timer" onClick={() => { setPaused(!paused); haptic('light'); }}>
                                        {paused ? '⏸' : '⏱️'} {formatTime(elapsed)}
                                    </div>
                                    <button className="action-btn-minimal" onClick={editTime}><Icons.Edit/></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="card" style={{background:'var(--bg-accent)'}}>
                        <h3>Plate Calculator</h3>
                        <input 
                            type="number" 
                            inputMode="decimal" 
                            placeholder="Total Weight (lbs)" 
                            value={plateCalc} 
                            onChange={e => setPlateCalc(e.target.value)} 
                        />
                        {plateCalc && plates.length > 0 && (
                            <>
                                <div className="barbell-container">
                                    <div className="bar-end"></div>
                                    {plates.map((p, i) => 
                                        Array(p.count).fill().map((_, j) => 
                                            <div key={`${i}-${j}`} className={`plate plate-${p.weight.toString().replace('.','_')}`}></div>
                                        )
                                    )}
                                    <div className="bar-shaft"></div>
                                </div>
                                <p style={{fontSize:'12px', color:'var(--text-secondary)', textAlign:'center', marginTop:'8px'}}>
                                    Per Side: {plates.map(p => `${p.weight}×${p.count}`).join(' + ')}
                                </p>
                            </>
                        )}
                    </div>

                    {sets.map((ex, exIdx) => {
                        const suggestion = getSuggestion(ex.name);
                        const trend = getTrend(ex.name);
                        
                        return (
                            <div key={exIdx} className="card" style={{position:'relative'}}>
                                {suggestion && suggestion.weight > 0 && (
                                    <div 
                                        className="suggestion-badge" 
                                        onClick={() => applySuggestion(exIdx)}
                                        title={suggestion.reason}
                                    >
                                        +{(suggestion.weight - parseFloat(getHistory(ex.name, 0)?.weight || 0)).toFixed(1)}
                                    </div>
                                )}
                                
                                <div style={{display:'flex', justifyContent:'space-between', marginBottom:'10px', alignItems:'center', gap:'8px'}}>
                                    <div style={{display:'flex', alignItems:'center', gap:'8px', flex: 1, minWidth: 0}}>
                                        <div style={{display:'flex', flexDirection:'column', gap:'2px'}}>
                                            <button 
                                                className="autofill-btn" 
                                                onClick={() => moveExercise(exIdx, -1)}
                                                style={{opacity: exIdx === 0 ? 0.3 : 1, padding:'2px'}}
                                                disabled={exIdx === 0}
                                                title="Move up"
                                            >
                                                <Icons.Up/>
                                            </button>
                                            <button 
                                                className="autofill-btn" 
                                                onClick={() => moveExercise(exIdx, 1)}
                                                style={{opacity: exIdx === sets.length - 1 ? 0.3 : 1, padding:'2px'}}
                                                disabled={exIdx === sets.length - 1}
                                                title="Move down"
                                            >
                                                <Icons.Down/>
                                            </button>
                                        </div>
                                        <div style={{flex: 1, minWidth: 0}}>
                                            <h3 style={{margin:0, wordBreak:'break-word'}}>{ex.name}</h3>
                                        </div>
                                        {trend && (
                                            <span className={`trend-indicator trend-${trend}`} title={`Trend: ${trend}`}>
                                                {trend === 'up' && '↗️'}
                                                {trend === 'down' && '↘️'}
                                                {trend === 'same' && '➡️'}
                                            </span>
                                        )}
                                    </div>
                                    <div style={{display:'flex', gap:'4px', flexShrink: 0}}>
                                        <button 
                                            className="action-btn-minimal" 
                                            style={{color: 'orange'}} 
                                            onClick={() => calcWarmup(ex.logs[0].weight)}
                                            title="Calculate warmup"
                                        >
                                            <Icons.Warmup/>
                                        </button>
                                        <button 
                                            className="action-btn-minimal" 
                                            onClick={() => setExpandedEx({...expandedEx, [exIdx]: !expandedEx[exIdx]})}
                                            title="Show description"
                                        >
                                            {expandedEx[exIdx] ? '−' : '?'}
                                        </button>
                                        <button 
                                            className="action-btn-minimal" 
                                            style={{color:'var(--danger)'}}
                                            onClick={() => removeExercise(exIdx)}
                                            title="Remove exercise"
                                        >
                                            <Icons.Trash/>
                                        </button>
                                    </div>
                                </div>
                                
                                {expandedEx[exIdx] && customWorkouts[selectedDay].exercises[exIdx] && (
                                    <p style={{fontSize:'13px', color:'var(--text-secondary)', marginBottom:'15px', padding:'10px', background:'var(--bg-accent)', borderRadius:'8px'}}>
                                        {customWorkouts[selectedDay].exercises[exIdx].description}
                                    </p>
                                )}
                                
                                {ex.logs.map((set, sIdx) => {
                                    const hist = getHistory(ex.name, sIdx);
                                    const isCompleted = completedSets[`${exIdx}-${sIdx}`];
                                    
                                    return (
                                        <div key={sIdx}>
                                            {hist && (
                                                <div className="last-workout">
                                                    Last: {hist.weight}×{hist.reps}
                                                </div>
                                            )}
                                            <div className={`set-row ${isCompleted ? 'completed' : ''}`}>
                                                <div 
                                                    className="set-label" 
                                                    onClick={() => markSetComplete(exIdx, sIdx)}
                                                    title="Mark complete"
                                                >
                                                    {sIdx + 1}
                                                </div>
                                                <input 
                                                    type="number" 
                                                    inputMode="decimal" 
                                                    placeholder="Reps" 
                                                    className="set-input" 
                                                    value={set.reps} 
                                                    onChange={e => {
                                                        const n = [...sets]; 
                                                        n[exIdx].logs[sIdx].reps = e.target.value; 
                                                        setSets(n);
                                                    }} 
                                                    onBlur={() => { 
                                                        if(set.weight && set.reps) { 
                                                            setRest(90); 
                                                            markSetComplete(exIdx, sIdx); 
                                                        }
                                                    }} 
                                                />
                                                <input 
                                                    type="number" 
                                                    inputMode="decimal" 
                                                    placeholder="Lbs" 
                                                    className="set-input" 
                                                    value={set.weight} 
                                                    onChange={e => {
                                                        const n = [...sets]; 
                                                        n[exIdx].logs[sIdx].weight = e.target.value; 
                                                        setSets(n);
                                                    }} 
                                                />
                                                <button 
                                                    className="autofill-btn" 
                                                    onClick={() => autoFill(exIdx, sIdx)}
                                                    title="Auto-fill from last workout"
                                                >
                                                    <Icons.Magic/>
                                                </button>
                                                <button 
                                                    className="action-btn-minimal" 
                                                    style={{color:'var(--danger)'}} 
                                                    onClick={() => removeSet(exIdx, sIdx)}
                                                    title="Remove set"
                                                >
                                                    <Icons.Close/>
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                                <button className="add-set-btn" onClick={() => addSet(exIdx)}>+ Add Set</button>
                                
                                {/* Exercise Notes */}
                                <div style={{marginTop: '12px'}}>
                                    <textarea
                                        placeholder="Exercise notes (e.g., 'felt strong today', 'lower back tight')..."
                                        value={workoutNotes[exIdx] || ''}
                                        onChange={(e) => {
                                            const newNotes = {...workoutNotes};
                                            newNotes[exIdx] = e.target.value;
                                            setWorkoutNotes(newNotes);
                                        }}
                                        style={{
                                            minHeight: '60px',
                                            fontSize: '13px',
                                            resize: 'vertical'
                                        }}
                                    />
                                </div>
                            </div>
                        );
                    })}
                    
                    <button className="btn btn-secondary" onClick={() => { setAddExerciseModal(true); haptic('light'); }}>
                        <Icons.Plus /> Add Exercise
                    </button>
                    <button className="btn btn-success" onClick={finish}>Complete Workout</button>
                    <button className="btn btn-danger-full" onClick={discardWorkout}>Discard Workout</button>
                    
                    {rest > 0 && (
                        <div className="timer-display">
                            <div>{rest}s</div>
                            <div className="timer-controls">
                                <span className="timer-mod" onClick={() => { setRest(rest - 10); haptic('light'); }}>-10</span>
                                <span className="timer-mod" onClick={() => { setRest(rest + 30); haptic('light'); }}>+30</span>
                            </div>
                        </div>
                    )}
                    
                    {addExerciseModal && (
                        <>
                            <div className="modal-backdrop" onClick={() => setAddExerciseModal(false)} />
                            <div className="note-modal">
                                <h3 style={{marginBottom:'15px'}}>Add Exercise</h3>
                                <input 
                                    type="text"
                                    value={newExerciseName}
                                    onChange={e => setNewExerciseName(e.target.value)}
                                    placeholder="Exercise name (e.g., Bicep Curls)"
                                    style={{marginBottom:'15px'}}
                                    autoFocus
                                    onKeyPress={e => { if (e.key === 'Enter') addExerciseToWorkout(); }}
                                />
                                <div style={{display:'flex', gap:'10px'}}>
                                    <button className="btn btn-primary" onClick={addExerciseToWorkout}>Add Exercise</button>
                                    <button className="btn btn-secondary" onClick={() => { setAddExerciseModal(false); setNewExerciseName(''); }}>Cancel</button>
                                </div>
                            </div>
                        </>
                    )}
                </div>
            );
        }

        function Stats({ workoutLog, personalRecords, customWorkouts }) {
            const [selectedLift, setSelectedLift] = useState(null);
            const [chartMode, setChartMode] = useState('max');
            const [analyticsView, setAnalyticsView] = useState('volume');
            
            const getLiftHistory = () => {
                if(!selectedLift) return [];
                return Object.entries(workoutLog)
                    .sort((a,b) => new Date(a[0]) - new Date(b[0]))
                    .map(([date, data]) => {
                        const ex = data.exercises?.find(e => e.name === selectedLift);
                        if(!ex) return null;
                        const maxWeight = Math.max(...ex.logs.map(l => parseFloat(l.weight) || 0));
                        const volume = ex.logs.reduce((acc, l) => acc + ((parseFloat(l.weight)||0) * (parseFloat(l.reps)||0)), 0);
                        return maxWeight > 0 ? { date, weight: maxWeight, volume } : null;
                    })
                    .filter(Boolean);
            };

            // Weekly volume by muscle
            const getWeeklyVolumeByMuscle = () => {
                const muscleVolume = {};
                const today = new Date();
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay() + 1);
                
                Object.entries(workoutLog).forEach(([date, data]) => {
                    const logDate = new Date(date);
                    if (logDate < weekStart) return;
                    
                    const dayData = customWorkouts[data.day];
                    if (!dayData || !dayData.muscleGroups) return;
                    
                    const dayVolume = data.tonnage || 0;
                    dayData.muscleGroups.forEach(muscle => {
                        muscleVolume[muscle] = (muscleVolume[muscle] || 0) + (dayVolume / dayData.muscleGroups.length);
                    });
                });
                
                return muscleVolume;
            };

            // Best day stats
            const getBestDayStats = () => {
                const dayStats = {};
                Object.entries(workoutLog).forEach(([date, data]) => {
                    if (!dayStats[data.day]) {
                        dayStats[data.day] = { totalVolume: 0, count: 0, prs: 0 };
                    }
                    dayStats[data.day].totalVolume += data.tonnage || 0;
                    dayStats[data.day].count += 1;
                    if (data.tonnage && data.tonnage > 10000) dayStats[data.day].prs += 1;
                });
                
                return Object.entries(dayStats)
                    .map(([day, stats]) => ({
                        day: customWorkouts[day]?.name || day,
                        avgVolume: Math.round(stats.totalVolume / stats.count),
                        prs: stats.prs,
                        count: stats.count
                    }))
                    .sort((a, b) => b.avgVolume - a.avgVolume);
            };

            // Tonnage history
            const getTonnageHistory = () => {
                return Object.entries(workoutLog)
                    .sort((a, b) => new Date(a[0]) - new Date(b[0]))
                    .slice(-20)
                    .map(([date, data]) => ({
                        date,
                        tonnage: data.tonnage || 0
                    }));
            };

            const liftData = getLiftHistory();
            const points = liftData.map((d, i) => {
                const val = chartMode === 'max' ? d.weight : d.volume;
                const max = Math.max(...liftData.map(l => chartMode === 'max' ? l.weight : l.volume)) * 1.1;
                const min = Math.min(...liftData.map(l => chartMode === 'max' ? l.weight : l.volume)) * 0.9;
                const y = 100 - ((val - min) / (max - min) * 100);
                const x = (i / (liftData.length > 1 ? liftData.length - 1 : 1)) * 300;
                return `${x},${y}`;
            }).join(' ');

            const muscleVolume = getWeeklyVolumeByMuscle();
            const maxMuscleVol = Math.max(...Object.values(muscleVolume), 1);
            const bestDayStats = getBestDayStats();
            const tonnageHistory = getTonnageHistory();
            
            const tonnagePoints = tonnageHistory.map((d, i) => {
                const max = Math.max(...tonnageHistory.map(h => h.tonnage)) * 1.1;
                const min = Math.min(...tonnageHistory.map(h => h.tonnage)) * 0.9;
                const y = 100 - ((d.tonnage - min) / (max - min) * 100);
                const x = (i / (tonnageHistory.length > 1 ? tonnageHistory.length - 1 : 1)) * 300;
                return `${x},${y}`;
            }).join(' ');

            return (
                <div>
                    <div className="stat-grid">
                        <div className="stat-card">
                            <div className="stat-val">{Object.keys(personalRecords).length}</div>
                            <div className="stat-lbl">Personal Records</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-val">{Object.keys(workoutLog).length}</div>
                            <div className="stat-lbl">Total Workouts</div>
                        </div>
                    </div>
                    
                    <div className="segmented-control">
                        <button className={`segment-btn ${analyticsView==='volume'?'active':''}`} onClick={()=>{ setAnalyticsView('volume'); haptic('light'); }}>Volume</button>
                        <button className={`segment-btn ${analyticsView==='best-day'?'active':''}`} onClick={()=>{ setAnalyticsView('best-day'); haptic('light'); }}>Best Days</button>
                        <button className={`segment-btn ${analyticsView==='tonnage'?'active':''}`} onClick={()=>{ setAnalyticsView('tonnage'); haptic('light'); }}>Tonnage</button>
                    </div>

                    {analyticsView === 'volume' && (
                        <div className="card">
                            <h3>This Week by Muscle</h3>
                            {Object.entries(muscleVolume).length > 0 ? (
                                Object.entries(muscleVolume).map(([muscle, vol]) => (
                                    <div key={muscle} className="muscle-group-bar">
                                        <div className="muscle-group-label">{muscle}</div>
                                        <div className="muscle-group-progress">
                                            <div className="muscle-group-fill" style={{width: `${(vol/maxMuscleVol)*100}%`}}>
                                                <span className="muscle-group-value">{(vol/1000).toFixed(1)}k</span>
                                            </div>
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <p style={{color:'var(--text-secondary)', textAlign:'center', padding:'20px 0'}}>No workouts this week yet</p>
                            )}
                        </div>
                    )}

                    {analyticsView === 'best-day' && (
                        <div className="card">
                            <h3>Best Performance Days</h3>
                            {bestDayStats.length > 0 ? (
                                bestDayStats.slice(0, 3).map((stat, idx) => (
                                    <div key={stat.day} className="best-day-card">
                                        <div className="best-day-header">
                                            <div>
                                                <div className="best-day-name">
                                                    {idx === 0 && '🥇 '}
                                                    {idx === 1 && '🥈 '}
                                                    {idx === 2 && '🥉 '}
                                                    {stat.day}
                                                </div>
                                                <div style={{fontSize:'12px', color:'var(--text-secondary)', marginTop:'4px'}}>
                                                    {stat.count} sessions • {stat.prs} PRs
                                                </div>
                                            </div>
                                            <div className="best-day-stat">{(stat.avgVolume/1000).toFixed(1)}k</div>
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <p style={{color:'var(--text-secondary)', textAlign:'center', padding:'20px 0'}}>Complete more workouts to see stats</p>
                            )}
                        </div>
                    )}

                    {analyticsView === 'tonnage' && (
                        <div className="card">
                            <h3>Tonnage Trend (Last 20)</h3>
                            {tonnageHistory.length > 1 ? (
                                <div className="chart-wrapper">
                                    <svg className="chart-svg" viewBox="0 0 300 100" preserveAspectRatio="none">
                                        <line x1="0" y1="25" x2="300" y2="25" className="chart-grid" />
                                        <line x1="0" y1="50" x2="300" y2="50" className="chart-grid" />
                                        <line x1="0" y1="75" x2="300" y2="75" className="chart-grid" />
                                        <polyline points={tonnagePoints} className="chart-line" />
                                    </svg>
                                </div>
                            ) : (
                                <p style={{color:'var(--text-secondary)', textAlign:'center', padding:'20px 0'}}>Need more data to show chart</p>
                            )}
                        </div>
                    )}
                    
                    <div className="card">
                        <h3>Lift Progress</h3>
                        <select 
                            onChange={(e) => { setSelectedLift(e.target.value); haptic('light'); }} 
                            value={selectedLift || ''} 
                            style={{marginBottom:'15px'}}
                        >
                            <option value="">Select Exercise</option>
                            {Object.keys(personalRecords).sort().map(k => (
                                <option key={k} value={k}>
                                    {k.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}
                                </option>
                            ))}
                        </select>
                        
                        {selectedLift && (
                            <div className="segmented-control">
                                <button className={`segment-btn ${chartMode==='max'?'active':''}`} onClick={()=>{ setChartMode('max'); haptic('light'); }}>Max Weight</button>
                                <button className={`segment-btn ${chartMode==='vol'?'active':''}`} onClick={()=>{ setChartMode('vol'); haptic('light'); }}>Volume</button>
                            </div>
                        )}

                        {selectedLift && liftData.length > 1 && (
                            <div className="chart-wrapper">
                                <svg className="chart-svg" viewBox="0 0 300 100" preserveAspectRatio="none">
                                    <line x1="0" y1="25" x2="300" y2="25" className="chart-grid" />
                                    <line x1="0" y1="50" x2="300" y2="50" className="chart-grid" />
                                    <line x1="0" y1="75" x2="300" y2="75" className="chart-grid" />
                                    <polyline points={points} className="chart-line" />
                                </svg>
                                <div style={{display:'flex', justifyContent:'space-between', fontSize:'10px', color:'var(--text-secondary)', marginTop:'5px'}}>
                                    <span>{new Date(liftData[0].date).toLocaleDateString(undefined, {month:'short', day:'numeric'})}</span>
                                    <span>{new Date(liftData[liftData.length-1].date).toLocaleDateString(undefined, {month:'short', day:'numeric'})}</span>
                                </div>
                            </div>
                        )}
                        {selectedLift && liftData.length <= 1 && (
                            <p style={{color:'var(--text-secondary)', textAlign:'center', padding:'20px 0'}}>Need more data to show trend</p>
                        )}
                    </div>

                    <div className="card">
                        <h3>Personal Records</h3>
                        {Object.entries(personalRecords).length > 0 ? (
                            Object.entries(personalRecords)
                                .sort((a, b) => b[1] - a[1])
                                .map(([k, v]) => (
                                    <div key={k} style={{borderBottom:'1px solid var(--border-color)', padding:'10px 0', display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                        <span style={{fontWeight:'600'}}>
                                            {k.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}
                                        </span>
                                        <span style={{fontWeight:'800', color:'var(--primary)', fontSize:'16px'}}>
                                            {Math.round(v)} lbs
                                        </span>
                                    </div>
                                ))
                        ) : (
                            <p style={{color:'var(--text-secondary)', textAlign:'center', padding:'20px 0'}}>Complete workouts to set PRs</p>
                        )}
                    </div>
                </div>
            ); 
        }
        
        function History({ workoutLog, setWorkoutLog, customWorkouts, deleteWorkout }) {
            const { showToast } = React.useContext(ToastContext);
            const [swipeState, setSwipeState] = useState({});
            const [editingWorkout, setEditingWorkout] = useState(null);
            const [editData, setEditData] = useState(null);
            
            const handleTouchStart = (date, e) => {
                setSwipeState({
                    [date]: {
                        startX: e.touches[0].clientX,
                        currentX: e.touches[0].clientX
                    }
                });
            };
            
            const handleTouchMove = (date, e) => {
                if (swipeState[date]) {
                    setSwipeState({
                        [date]: {
                            ...swipeState[date],
                            currentX: e.touches[0].clientX
                        }
                    });
                }
            };
            
            const handleTouchEnd = (date) => {
                const state = swipeState[date];
                if (state && state.startX - state.currentX > 100) {
                    deleteWorkout(date);
                    showToast('Workout deleted', 'success');
                    haptic('medium');
                }
                setSwipeState({});
            };
            
            const handleDelete = (date) => {
                deleteWorkout(date);
                showToast('Workout deleted', 'success');
                haptic('medium');
            };

            const startEdit = (date, data) => {
                setEditingWorkout(date);
                setEditData(JSON.parse(JSON.stringify(data))); // Deep copy
                haptic('light');
            };

            const cancelEdit = () => {
                setEditingWorkout(null);
                setEditData(null);
                haptic('light');
            };

            const saveEdit = () => {
                if (!editingWorkout || !editData) return;
                
                // Recalculate tonnage
                let tonnage = 0;
                editData.exercises.forEach(ex => ex.logs.forEach(l => {
                    if (l.weight && l.reps) {
                        tonnage += parseFloat(l.weight) * parseFloat(l.reps);
                    }
                }));
                editData.tonnage = tonnage;
                
                // Update workout log
                const newLog = {...workoutLog};
                newLog[editingWorkout] = editData;
                setWorkoutLog(newLog);
                
                showToast('Workout updated', 'success');
                haptic('medium');
                setEditingWorkout(null);
                setEditData(null);
            };

            const updateEditSet = (exIdx, setIdx, field, value) => {
                const newData = {...editData};
                newData.exercises[exIdx].logs[setIdx][field] = value;
                setEditData(newData);
            };

            const updateEditNote = (exIdx, value) => {
                const newData = {...editData};
                newData.exercises[exIdx].note = value;
                setEditData(newData);
            };
            
            return (
                <div>
                    {Object.entries(workoutLog).length > 0 ? (
                        Object.entries(workoutLog)
                            .sort((a, b) => new Date(b[0]) - new Date(a[0]))
                            .map(([date, data]) => {
                                const swipe = swipeState[date];
                                const translateX = swipe ? Math.min(0, swipe.currentX - swipe.startX) : 0;
                                
                                return (
                                    <div 
                                        key={date} 
                                        className="card swipeable"
                                        style={{transform: `translateX(${translateX}px)`}}
                                        onTouchStart={(e) => handleTouchStart(date, e)}
                                        onTouchMove={(e) => handleTouchMove(date, e)}
                                        onTouchEnd={() => handleTouchEnd(date)}
                                    >
                                        {swipe && translateX < -50 && (
                                            <div className="swipe-actions">
                                                <span className="swipe-delete-btn">DELETE</span>
                                            </div>
                                        )}
                                        
                                        <div className="history-header">
                                            <div>
                                                <h4 style={{margin:0, fontWeight:'700'}}>
                                                    {new Date(date).toLocaleDateString(undefined, {
                                                        weekday: 'short',
                                                        month: 'short',
                                                        day: 'numeric',
                                                        year: 'numeric'
                                                    })}
                                                </h4>
                                                <p style={{fontWeight:'700', textTransform:'capitalize', color:'var(--primary)', marginTop:'4px'}}>
                                                    {customWorkouts[data.day]?.name || data.day}
                                                </p>
                                            </div>
                                            <div style={{display:'flex', gap:'8px'}}>
                                                <button 
                                                    className="action-btn-minimal" 
                                                    onClick={() => startEdit(date, data)}
                                                    title="Edit workout"
                                                >
                                                    <Icons.Edit />
                                                </button>
                                                <button 
                                                    className="action-btn-minimal" 
                                                    style={{color:'var(--danger)'}} 
                                                    onClick={() => handleDelete(date)}
                                                    title="Delete workout"
                                                >
                                                    <Icons.Trash />
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div style={{display:'flex', gap:'15px', marginBottom:'10px', fontSize:'13px', color:'var(--text-secondary)'}}>
                                            {data.duration && (
                                                <span>⏱️ {Math.floor(data.duration/60)}m {data.duration%60}s</span>
                                            )}
                                            {data.tonnage && (
                                                <span>💪 {data.tonnage.toLocaleString()} lbs</span>
                                            )}
                                        </div>
                                        
                                        {data.exercises && data.exercises.map((ex, i) => {
                                            const setsSummary = ex.logs
                                                .filter(l => l.weight && l.reps)
                                                .map(l => `${l.weight}×${l.reps}`)
                                                .join(', ');
                                            if (!setsSummary) return null;
                                            
                                            return (
                                                <div key={i} className="history-exercise">
                                                    <strong style={{fontSize:'14px'}}>{ex.name}</strong>
                                                    <div style={{fontSize:'13px', color:'var(--text-secondary)', marginTop:'4px'}}>
                                                        {setsSummary}
                                                    </div>
                                                    {ex.note && (
                                                        <div style={{fontSize:'12px', color:'var(--text-tertiary)', marginTop:'4px', fontStyle:'italic'}}>
                                                            Note: {ex.note}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                );
                            })
                    ) : (
                        <div style={{textAlign:'center', padding:'60px 20px'}}>
                            <div style={{fontSize:'48px', marginBottom:'20px'}}>💪</div>
                            <h3 style={{marginBottom:'10px'}}>No Workouts Yet</h3>
                            <p style={{color:'var(--text-secondary)'}}>Start your first session to begin tracking your progress</p>
                        </div>
                    )}
                    
                    {/* Edit Workout Modal */}
                    {editingWorkout && editData && (
                        <>
                            <div className="modal-backdrop" onClick={cancelEdit} style={{zIndex: 10000}} />
                            <div style={{
                                position: 'fixed',
                                top: '50%',
                                left: '50%',
                                transform: 'translate(-50%, -50%)',
                                background: 'var(--bg-secondary)',
                                borderRadius: '20px',
                                padding: '24px',
                                maxWidth: '90vw',
                                maxHeight: '80vh',
                                overflow: 'auto',
                                zIndex: 10001,
                                boxShadow: '0 8px 32px rgba(0,0,0,0.3)',
                                width: '500px'
                            }}>
                                <h2 style={{marginBottom: '20px'}}>Edit Workout</h2>
                                
                                {editData.exercises.map((ex, exIdx) => (
                                    <div key={exIdx} style={{marginBottom: '20px', padding: '16px', background: 'var(--bg-accent)', borderRadius: '12px'}}>
                                        <h3 style={{marginBottom: '12px', fontSize: '16px'}}>{ex.name}</h3>
                                        
                                        {ex.logs.map((log, setIdx) => (
                                            <div key={setIdx} style={{display: 'flex', gap: '8px', marginBottom: '8px', alignItems: 'center'}}>
                                                <span style={{width: '30px', fontWeight: '700', fontSize: '14px', color: 'var(--text-secondary)'}}>{setIdx + 1}</span>
                                                <input
                                                    type="number"
                                                    inputMode="decimal"
                                                    placeholder="Reps"
                                                    value={log.reps}
                                                    onChange={(e) => updateEditSet(exIdx, setIdx, 'reps', e.target.value)}
                                                    style={{width: '70px', padding: '8px', fontSize: '14px'}}
                                                />
                                                <input
                                                    type="number"
                                                    inputMode="decimal"
                                                    placeholder="Lbs"
                                                    value={log.weight}
                                                    onChange={(e) => updateEditSet(exIdx, setIdx, 'weight', e.target.value)}
                                                    style={{width: '70px', padding: '8px', fontSize: '14px'}}
                                                />
                                            </div>
                                        ))}
                                        
                                        <textarea
                                            placeholder="Exercise notes..."
                                            value={ex.note || ''}
                                            onChange={(e) => updateEditNote(exIdx, e.target.value)}
                                            style={{marginTop: '8px', minHeight: '50px', fontSize: '13px'}}
                                        />
                                    </div>
                                ))}
                                
                                <div style={{display: 'flex', gap: '10px', marginTop: '20px'}}>
                                    <button className="btn btn-primary" onClick={saveEdit}>Save Changes</button>
                                    <button className="btn btn-secondary" onClick={cancelEdit}>Cancel</button>
                                </div>
                            </div>
                        </>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
